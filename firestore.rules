rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- FUNCTIONS ---
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // --- RULES ---

    // 1. PATIENTS
    // Solo el dueño del paciente (userId field) puede leer/escribir.
    match /patients/{patientId} {
      allow read: if isAuthenticated() && (resource.data.userId == request.auth.uid || isOwner(resource.data.userId));
      // Create: El userId del documento debe coincidir con el del usuario autenticado.
      allow create: if isOwner(request.resource.data.userId);
      // Update: No se permite cambiar el userId.
      allow update: if isOwner(resource.data.userId) 
                    && request.resource.data.userId == resource.data.userId;
      allow delete: if isOwner(resource.data.userId);
    }

    // 2. CONFIG/SETTINGS
    // Archivos de configuración por usuario.
    match /config/{configId} {
       // Asumiendo que configId es 'settings_' + uid, o que el doc tiene userId
       allow read, write: if isAuthenticated() && (configId == 'settings_' + request.auth.uid || resource.data.userId == request.auth.uid);
    }

    // 3. DEFAULT DENY
    match /{document=**} {
      allow read, write: if false; 
    }
  }
}
